<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My AR Art</title>
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden;}
    #overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.6);color:#fff;font:14px/1.5 system-ui;text-align:center;padding:16px;z-index:9999;}
    #btn{padding:12px 18px;border-radius:999px;border:0;font-size:16px;}
    #log{position:fixed;left:12px;right:12px;top:12px;color:#00ff7f;background:rgba(0,0,0,.55);
      font:12px/1.4 ui-monospace, Menlo, monospace;padding:8px;border-radius:8px;z-index:10000;white-space:pre-wrap;}
  </style>
</head>
<body>
  <div id="overlay">
    <div>
      <button id="btn">ARを開始</button>
      <div style="margin-top:10px;opacity:.9">押したらカメラ許可 → ターゲット画像を映してください</div>
    </div>
  </div>
  <div id="log"></div>

  <div id="root"></div>

  <script>
    const logEl = document.getElementById('log');
    const overlay = document.getElementById('overlay');
    const btn = document.getElementById('btn');
    const root = document.getElementById('root');

    const log = (m)=> logEl.textContent += (logEl.textContent? "\n":"") + m;

    function loadScript(url){
      return new Promise((resolve, reject)=>{
        const s = document.createElement('script');
        s.src = url;
        s.onload = ()=> resolve(url);
        s.onerror = ()=> reject(new Error('FAILED: ' + url));
        document.head.appendChild(s);
      });
    }

    async function loadWithFallback(urls){
      for (const u of urls){
        try { const ok = await loadScript(u); log('LOADED: ' + ok); return; }
        catch(e){ log(String(e.message)); }
      }
      throw new Error('スクリプトが読み込めません（コンテンツブロッカー/通信を確認）');
    }

    btn.addEventListener('click', async ()=>{
      try{
        logEl.textContent = '';
        // まず assets の存在チェック（404ならここで分かる）
        const t = await fetch('./targets.mind', {cache:'no-store'});
        log(`targets.mind -> ${t.status}`);
        if(!t.ok) throw new Error('targets.mind が見つかりません');
        const a = await fetch('./art.png', {cache:'no-store'});
        log(`art.png -> ${a.status}`);
        if(!a.ok) throw new Error('art.png が見つかりません');

        // A-Frame → MindAR の順でロード（CDNフォールバック付き）
        await loadWithFallback([
          'https://aframe.io/releases/1.3.0/aframe.min.js'
        ]);
        await loadWithFallback([
          'https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-image-aframe.prod.js',
          'https://unpkg.com/mind-ar@1.1.4/dist/mindar-image-aframe.prod.js'
        ]);

        if (!window.AFRAME) throw new Error('AFRAME が見つかりません');
        log('AFRAME OK');

        // ここで初めてシーンを生成（読み込み順トラブルを回避）
        root.innerHTML = `
          <a-scene id="scene"
            mindar-image="imageTargetSrc: ./targets.mind; autoStart: false;"
            vr-mode-ui="enabled:false"
            device-orientation-permission-ui="enabled:false"
            embedded>
            <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>
            <a-entity mindar-image-target="targetIndex: 0">
              <a-image src="./art.png" width="1.5" height="1.5" position="0 0 0.01"></a-image>
            </a-entity>
          </a-scene>
        `;

        const sceneEl = document.getElementById('scene');

        // scene loaded を待ってから start（iPhoneで重要）
        await new Promise(res => sceneEl.addEventListener('loaded', res, {once:true}));
        log('scene loaded');

        const sys = sceneEl.systems && sceneEl.systems['mindar-image-system'];
        if (!sys || typeof sys.start !== 'function') throw new Error('mindar-image-system が初期化されませんでした');

        await sys.start();
        overlay.style.display = 'none';
        log('AR started');
      }catch(e){
        alert('AR開始に失敗しました。\n' + (e?.message ?? e));
        log('ERROR: ' + (e?.message ?? e));
      }
    });
  </script>
</body>
</html>


